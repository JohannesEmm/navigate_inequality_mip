v_adjust_numbers <- 0 #was: .8

#redo the ordered dataset
data_welfare_effect_reordered <- data_welfare_effect_revision %>% mutate(Scenario.y=as.factor(Scenario.y), Scenario.y=fct_relevel(Scenario.y, c("REF", "1150", "Paris", "1150_redist", "Paris_redist", "REF_impact", "1150_impact", "1150_impact_redist", "Paris_impact", "Paris_impact_redist"))) 
data_welfare_effect_reordered <- data_welfare_effect_reordered %>% mutate(scenarioclass=case_when(Scenario.y=="REF_impact" ~ "No Climate Policy", Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", TRUE ~ NA))


#boxplot old Fig1
p_boxplots_gini <- ggplot(data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC")))) + geom_point(aes(x = Region, y = 100*(value.x_Equality_index-value.y_Equality_index), color=Model, shape=Model), size = 1) + facet_grid(Scenario.y.nice ~ Year, scales = "free")  + theme_bw() + geom_hline(yintercept = 0) + labs(y="Change in Gini from Reference [points]", x="", title="Impact on the Gini index") + geom_boxplot(aes(x = Region, y = 100*(value.x_Equality_index-value.y_Equality_index)), alpha=0.2, color="grey50") + scale_x_discrete(limits = c("United States", "Canada", "France", "Japan", "Russia", "Mexico", "China", "Brazil", "South Africa", "India", "AVERAGE")) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_shape_manual(values=seq(0,9)) + geom_boxplot(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=100*(value.x_Equality_index-value.y_Equality_index)) %>% summarize(value=mean(value)), aes(x=11, y=value), alpha=0.4, color="black")+ geom_point(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=100*(value.x_Equality_index-value.y_Equality_index)) %>% summarize(value=mean(value)), aes(x=11, y=value, color=Model, shape=Model), size=1)
print(p_boxplots_gini + geom_text(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=100*(value.x_Equality_index-value.y_Equality_index)) %>% summarize(value=mean(value)) %>% ungroup() %>% group_by(Year, Scenario.y.nice) %>% summarize(value=median(value)) %>% mutate(label = sprintf("%+.1f", value)) %>% ungroup(), aes(x=11, y=value+0.5*sign(value), label=label)))
#color facets background
g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
ggsave(filename = file.path(graphdir, "Gini_boxplot_final.png"), width = 12, height = 8, plot = g)




#now same plot for GDP:
p_boxplots_gdp <- ggplot(data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC")))) + geom_point(aes(x = Region, y = 100*(`value.y_GDP|PPP`/`value.x_GDP|PPP`-1), color=Model, shape=Model), size = 1) + facet_grid(Scenario.y.nice ~ Year, scales = "free")  + theme_bw() + geom_hline(yintercept = 0) + labs(y="Change in GDP from Reference [%]", x="", title="Impact on GDP") + geom_boxplot(aes(x = Region, y = 100*(`value.y_GDP|PPP`/`value.x_GDP|PPP`-1)), alpha=0.2, color="grey50") + scale_x_discrete(limits = c("United States", "Canada", "France", "Japan", "Russia", "Mexico", "China", "Brazil", "South Africa", "India", "AVERAGE")) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_shape_manual(values=seq(0,9)) + geom_boxplot(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=100*(`value.y_GDP|PPP`/`value.x_GDP|PPP`-1)) %>% summarize(value=mean(value)), aes(x=11, y=value), alpha=0.4, color="black")+ geom_point(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value= 100*(`value.y_GDP|PPP`/`value.x_GDP|PPP`-1)) %>% summarize(value=mean(value)), aes(x=11, y=value, color=Model, shape=Model), size=1)
print(p_boxplots_gdp + geom_text(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=100*(`value.y_GDP|PPP`/`value.x_GDP|PPP`-1)) %>% summarize(value=mean(value)) %>% ungroup() %>% group_by(Year, Scenario.y.nice) %>% summarize(value=median(value)) %>% mutate(label = sprintf("%+.1f", value)) %>% ungroup(), aes(x=11, y=value+2*sign(value), label=label)))
g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
ggsave(filename = file.path(graphdir, "GDP_boxplot_final.png"), width = 12, height = 8, plot = g)



#finally same plot for Sen-Foster Welfare
p_boxplots_welfare <- ggplot(data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC")))) + 
  geom_point(aes(x = Region, y = 100*((`value.y_GDP|PPP`*value.y_Equality_index)/(`value.x_GDP|PPP`*value.x_Equality_index)-1), color=Model, shape=Model), size = 1) + facet_grid(Scenario.y.nice ~ Year, scales = "free")  + theme_bw() + geom_hline(yintercept = 0) + labs(y="Change in Welfare from Reference [%]", x="", title="Impact on Welfare") + geom_boxplot(aes(x = Region, y = 100*((`value.y_GDP|PPP`*value.y_Equality_index)/(`value.x_GDP|PPP`*value.x_Equality_index)-1)), alpha=0.2, color="grey50") + scale_x_discrete(limits = c("United States", "Canada", "France", "Japan", "Russia", "Mexico", "China", "Brazil", "South Africa", "India", "AVERAGE")) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_shape_manual(values=seq(0,9)) + geom_boxplot(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=100*((`value.y_GDP|PPP`*value.y_Equality_index)/(`value.x_GDP|PPP`*value.x_Equality_index)-1)) %>% summarize(value=mean(value)), aes(x=11, y=value), alpha=0.4, color="black")+ geom_point(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value= 100*((`value.y_GDP|PPP`*value.y_Equality_index)/(`value.x_GDP|PPP`*value.x_Equality_index)-1)) %>% summarize(value=mean(value)), aes(x=11, y=value, color=Model, shape=Model), size=1)

print(p_boxplots_welfare + geom_text(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value= 100*((`value.y_GDP|PPP`*value.y_Equality_index)/(`value.x_GDP|PPP`*value.x_Equality_index)-1)) %>% summarize(value=mean(value, na.rm = T)) %>% ungroup() %>% group_by(Year, Scenario.y.nice) %>% summarize(value=median(value)) %>% mutate(label = sprintf("%+.1f", value)) %>% ungroup(), aes(x=11, y=value+2*sign(value), label=label)))
g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
ggsave(filename = file.path(graphdir, "Welfare_boxplot_final.png"), width = 12, height = 8, plot = g)










#Map of mean effects on Gini (Figure 2)
data_for_map <- data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2070, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% mutate(Year=as.character(Year)) %>% filter(Year %in% c(2030, 2050, 2100)) %>% ungroup() %>% group_by(Region, Year, Scenario.y.nice) %>% summarize(gini_mean_change=mean(100*(value.x_Equality_index-value.y_Equality_index)), gini_median_change=median(100*(value.x_Equality_index-value.y_Equality_index)), welfare_median_change=median(100*((`value.y_GDP|PPP`*value.y_Equality_index)/(`value.x_GDP|PPP`*value.x_Equality_index)-1)), ede_median_change=median(100*((`value.y_GDP|PPP`*(1-value.y_Atkinson_1))/(`value.x_GDP|PPP`*(1-value.x_Atkinson_1))-1)), gdp_median_change=median(100*((`value.y_GDP|PPP`)/(`value.x_GDP|PPP`)-1)), D8D2_median_change=median(((`value.y_D8D2`)-(`value.x_D8D2`))), Atkinson_1_median_change=median(((`value.y_Atkinson_1`)-(`value.x_Atkinson_1`))), 
      gini_agreement=paste0(sum(abs(sign(100*(value.x_Equality_index-value.y_Equality_index)))[sign(100*(value.x_Equality_index-value.y_Equality_index)) == sign(median(100*(value.x_Equality_index-value.y_Equality_index)))]), "/", n()),
      gini_agreement_num=sum(abs(sign(100*(value.x_Equality_index-value.y_Equality_index)))[sign(100*(value.x_Equality_index-value.y_Equality_index)) == sign(median(100*(value.x_Equality_index-value.y_Equality_index)))]) / n(),
      gdp_agreement_num=sum(abs(sign(100*((`value.y_GDP|PPP`)/(`value.x_GDP|PPP`)-1)))[sign(100*((`value.y_GDP|PPP`)/(`value.x_GDP|PPP`)-1)) == sign(median(100*((`value.y_GDP|PPP`)/(`value.x_GDP|PPP`)-1)))]) / n(),
      ede_agreement_num=sum(abs(sign(100*((`value.y_GDP|PPP`*(1-value.y_Atkinson_1))/(`value.x_GDP|PPP`*(1-value.x_Atkinson_1))-1)))[sign(100*((`value.y_GDP|PPP`*(1-value.y_Atkinson_1))/(`value.x_GDP|PPP`*(1-value.x_Atkinson_1))-1)) == sign(median(100*((`value.y_GDP|PPP`*(1-value.y_Atkinson_1))/(`value.x_GDP|PPP`*(1-value.x_Atkinson_1))-1)))])/ n(),
      D8D2_agreement_num=sum(abs(sign(100*(value.x_D8D2-value.y_D8D2)))[sign(100*(value.x_D8D2-value.y_D8D2)) == sign(median(100*(value.x_D8D2-value.y_D8D2)))]) / n()
  )

data_for_map <- data_for_map %>% mutate(iso_a3 = countrycode::countrycode(Region, "country.name", "iso3c"))
sf_use_s2(FALSE) #to avoid errors
world <- ne_countries(scale = "medium", returnclass = "sf")
world <- suppressWarnings(cbind(world, st_coordinates(st_centroid(world$geometry))))
#some countries don't have iso3_a code
world <- world %>% mutate(iso_a3 = ifelse(iso_a3==-99, iso_a3_eh, iso_a3))
#Add data to world polygon
data_map_geometry <- data_for_map %>% ungroup() %>% full_join(world) %>% filter(!is.na(gini_mean_change)) %>% as.data.frame()
#MEDIAN, update colors
ggplot(data = data_map_geometry) + borders("world", colour = "grey80", fill = NA) + geom_sf(aes(fill = gini_median_change, geometry = geometry)) + ggtitle("Impact on the Gini index [Model median]") + labs(fill = "Gini index change", x = "", y = "", pattern="Agreement") + 
  geom_sf_pattern(data = subset(data_map_geometry, gini_agreement_num < 0.66), aes(pattern = "Agreement < 66%", geometry = geometry), pattern = 'stripe', pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.02, pattern_color="grey20", pattern_alpha=0.5, show.legend = "point") + scale_pattern_manual(values = c("Agreement < 66%" = "stripe")) +
  theme_bw() + theme(strip.background = element_rect(fill = "white"), legend.position = "bottom") + coord_sf(ylim = c(-50, 90))  + facet_grid(Scenario.y.nice ~ Year) + geom_sf_text(aes(label = sprintf("%+.1f", gini_median_change) , geometry = geometry), colour = "black", size=3.5) + theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) + theme(strip.text.y = element_text(size = 7)) + scale_fill_gradient2(low="blue", high="red", mid = "grey", midpoint = 0, guide="colorbar",na.value="white", lim = c(-6, +3)) 
g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
ggsave(filename = file.path(graphdir, "Gini_map.pdf"), width = 11, height = 7.5, plot = g, device = cairo_pdf)  


#smaller map for Research Briefing
data_map_geometry_briefing <- data_map_geometry %>% filter(Year!=2050)# & Scenario.y.nice!="Paris")
ggplot(data = data_map_geometry_briefing) + borders("world", colour = "grey80", fill = NA) + geom_sf(aes(fill = gini_median_change, geometry = geometry)) + ggtitle("Impact on the Gini index [Model median]") + labs(fill = "Points", x = "", y = "", pattern="Agreement") + 
  geom_sf_pattern(data = subset(data_map_geometry_briefing, gini_agreement_num < 0.66), aes(pattern = "Agreement < 66%", geometry = geometry), pattern = 'stripe', pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.02, pattern_color="grey20", pattern_alpha=0.5, show.legend = "point") + scale_pattern_manual(values = c("Agreement < 66%" = "stripe")) +
  theme_bw() + theme(strip.background = element_rect(fill = "white"), legend.position = "bottom") + coord_sf(ylim = c(-50, 90))  + facet_grid(Scenario.y.nice ~ Year) + geom_sf_text(aes(label = sprintf("%+.1f", gini_median_change) , geometry = geometry), colour = "black", size=3.5) + theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) + theme(strip.text.y = element_text(size = 7), legend.position = "right") + scale_fill_gradient2(low="blue", high="red", mid = "grey", midpoint = 0, guide="colorbar",na.value="white", lim = c(-6, +3)) 
g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
 ggsave(filename = file.path(graphdir, "Gini_map_briefing.pdf"), width = 7, height = 9, plot = g, device = cairo_pdf)





ggplot(data = data_map_geometry) + borders("world", colour = "grey80", fill = NA) + geom_sf(aes(fill = ede_median_change, geometry = geometry)) + ggtitle("Impact on the EDE based welfare [Model median]") + labs(fill = "EDE change [%]", x = "", y = "", pattern="Agreement") + 
  geom_sf_pattern(data = subset(data_map_geometry, ede_agreement_num < 0.66), aes(pattern = "Agreement < 66%", geometry = geometry), pattern = 'stripe', pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.02, pattern_color="grey20", pattern_alpha=0.5, show.legend = "point") + scale_pattern_manual(values = c("Agreement < 66%" = "stripe")) +
  theme_bw() + theme(strip.background = element_rect(fill = "white"), legend.position = "bottom") + coord_sf(ylim = c(-50, 90))  + facet_grid(Scenario.y.nice ~ Year) + geom_sf_text(aes(label = sprintf("%+.1f", ede_median_change) , geometry = geometry), colour = "black", size=3.5) + theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) + theme(strip.text.y = element_text(size = 7)) + scale_fill_gradient2(low="red", high="blue", mid = "grey", midpoint = 0, guide="colorbar",na.value="white", lim = c(-11, +14)) 
g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
ggsave(filename = file.path(graphdir, "EDE_map.pdf"), width = 11, height = 7.5, plot = g, device = cairo_pdf)  




#### MODEL DIFFERENCES
data_welfare_effect_reordered <- data_welfare_effect_reordered %>% mutate(Type=case_when(Model %in% c("AIM", "GEM-E3", "Imaclim") ~ "CGE", Model %in% c("ReMIND", "WITCH") ~ "DP-IAM", Model %in% c("NICE", "RICE50+") ~ "CB-IAM", Model %in% c("E3ME") ~ "Macroeconometric", TRUE ~ "Other")) %>% mutate(Model_letter=ifelse(Model=="RICE50+", "+", substr(Model,1,1)), Year_Model=paste0(Model_letter, "&", Year)) %>% ungroup() %>% arrange(as.numeric(Year), Model_letter) %>% mutate(Year_Model = factor(Year_Model, levels =  unique(Year_Model)))


#Gini aggregated over time (raw Figure 1)
ggplot(data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% arrange(Type)  %>% mutate(Model = factor(Model, levels =  unique(Model))) %>% mutate(Year=as.character(Year), Model_offset=as.factor(Model), Model_offset=as.numeric(Model_offset), Year=gsub("2100", "2075", Year))) + labs(x="", y="", title = "", color ="Model") + facet_grid(Scenario.y.nice ~ ., scales = "free")  + theme_bw() + geom_hline(yintercept = 0) + labs(y="Change in Gini from Reference [points]", x="", title="Impact on the Gini index by Model and Model type") + scale_shape_manual(values=seq(0,9)) + theme(strip.text.y = element_text(size = 6)) +geom_point(aes(x = as.numeric(Year)+(Model_offset-4.5)/1.0, y = 100*(value.x_Equality_index-value.y_Equality_index), color=Model, shape=Type)) + scale_x_continuous(breaks = c(2030, 2050, 2075), labels = c(2030, 2050, 2100)) + scale_shape_manual(values = c(15, 16, 17, 18))  + geom_text_repel(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=100*(value.x_Equality_index-value.y_Equality_index)) %>% summarize(value=mean(value)) %>% ungroup() %>% group_by(Year, Scenario.y.nice) %>% summarize(gini_agreement_num=paste0(round(100*sum(abs(sign(value))[sign(value) == sign(median(value))]) / n()),"%"), value=median(value)) %>% mutate(label = sprintf("%+.1f", value)) %>% ungroup() %>% mutate(Year=gsub(2100, 2075, Year)), aes(x=as.numeric(Year), y=value+v_adjust_numbers*sign(value), label=paste0(label, "\n Ag. ", gini_agreement_num)), nudge_x = 7, nudge_y=0.2, min.segment.length = 0, arrow=arrow(angle = 30, length = unit(0.1, "inches"),ends = "last", type = "closed"))

#only a few facets having same scales
source("scale_inidividual_facet_y_axes.R")
ggplot_build(last_plot())$layout$panel_scales_y[[3]]$range$range
scale_inidividual_facet_y_axes(last_plot(), ylims = list(c(-3.5,+3.5), c(-3.5,3.5), c(NULL, NULL)))
#scale_inidividual_facet_y_axes(last_plot(), ylims = list(c(-11.82,3.5), c(-11.82,3.5), c(-11.82,3.5)))


g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
ggsave(filename = file.path(graphdir, "Gini_violinplot_final_modeldifferences.pdf"), width = 7, height = 5, plot = g)

#Gini with maps (Figure 1)
p_map_gini <- ggplot(data = data_map_geometry %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100)) + borders("world", colour = "grey80", fill = NA) + 
  geom_sf(aes(fill = gini_median_change, geometry = geometry)) + scale_fill_gradient2(low="blue", high="red", mid = "grey", midpoint = 0, guide="colorbar",na.value="white")+ ggtitle("") + labs(fill = "", x = "", y = "") + 
  geom_sf_pattern(data = subset(data_map_geometry %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100), gini_agreement_num < 0.66), aes(pattern = "Agreement < 66%", geometry = geometry), pattern = 'stripe', pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.02, pattern_color="grey20", pattern_alpha=0.5, show.legend = "point") + scale_pattern_manual(values = c("Agreement < 66%" = "stripe")) + 
  theme_bw() + theme(strip.background = element_rect(fill = "grey"), legend.position = "bottom") + coord_sf(ylim = c(-50, 90))  + facet_grid(. ~ Year) + 
  #geom_sf_text(aes(label = sprintf("%+.1f", gini_median_change) , geometry = geometry), colour = "black", size=3.5) + 
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) + theme(strip.text.y = element_text(size = 7), legend.position = c(.5,.15), legend.direction = "horizontal", legend.background=element_blank()) + theme(panel.spacing = unit(10, "lines"))
#combined
ggpubr::ggarrange(g, p_map_gini, ncol=1, nrow=2, heights = c(2.2, 1.1), align = "hv")
ggsave(filename = file.path(graphdir, "Gini_violinplot_final_modeldifferences_withmaps.pdf"), width = 8, height = 6, device = cairo_pdf) 




#GDP
ggplot(data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% arrange(Type)  %>% mutate(Model = factor(Model, levels =  unique(Model))) %>% mutate(Year=as.character(Year), Model_offset=as.factor(Model), Model_offset=as.numeric(Model_offset), Year=gsub("2100", "2075", Year))) + labs(x="", y="", title = "", color ="Model") + facet_grid(Scenario.y.nice ~ ., scales = "free")  + theme_bw() + geom_hline(yintercept = 0) + labs(y="Change in GDP from Reference [%]", x="", title="Impact on GDP by Model and Model type") + scale_shape_manual(values=seq(0,9)) + theme(strip.text.y = element_text(size = 6)) +geom_point(aes(x = as.numeric(Year)+(Model_offset-4.5)/1.0, y = 100*(`value.y_GDP|PPP`/`value.x_GDP|PPP`-1), color=Model, shape=Type)) + scale_x_continuous(breaks = c(2030, 2050, 2075), labels = c(2030, 2050, 2100)) + scale_shape_manual(values = c(15, 16, 17, 18)) + geom_text_repel(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=100*(`value.y_GDP|PPP`/`value.x_GDP|PPP`-1)) %>% summarize(value=mean(value)) %>% ungroup() %>% group_by(Year, Scenario.y.nice) %>% summarize(gdp_agreement_num=paste0(round(100*sum(abs(sign(value))[sign(value) == sign(median(value))]) / n()),"%"), value=median(value)) %>% mutate(label = sprintf("%+.1f", value)) %>% ungroup() %>% mutate(Year=gsub(2100, 2075, Year)), aes(x=as.numeric(Year), y=value+v_adjust_numbers*sign(value), label=paste0(label, "\n Ag. ", gdp_agreement_num)), nudge_x = 7, nudge_y=0.2, min.segment.length = 0, arrow=arrow(angle = 30, length = unit(0.1, "inches"),ends = "last", type = "closed"))

ggplot_build(last_plot())$layout$panel_scales_y[[2]]$range$range
scale_inidividual_facet_y_axes(last_plot(), ylims = list(c(-33.2,13.3), c(-33.2,13.3), c(-33.2,13.3)))

g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
ggsave(filename = file.path(graphdir, "GDP_violinplot_final_modeldifferences.pdf"), width = 7, height = 5, plot = g, device = cairo_pdf)

#GDP with maps (Figure 3)
p_map_gdp <- ggplot(data = data_map_geometry %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100)) + borders("world", colour = "grey80", fill = NA) + 
  geom_sf(aes(fill = gdp_median_change, geometry = geometry)) + scale_fill_gradient2(low="red", high="blue", mid = "grey", midpoint = 0, guide="colorbar",na.value="white")+ ggtitle("") + labs(fill = "", x = "", y = "") + theme_bw() + theme(strip.background = element_rect(fill = "grey"), legend.position = "bottom") + coord_sf(ylim = c(-50, 90))  + facet_grid(. ~ Year) + 
  geom_sf_pattern(data = subset(data_map_geometry %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100), gdp_agreement_num < 0.66), aes(pattern = "Agreement < 66%", geometry = geometry), pattern = 'stripe', pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.02, pattern_color="grey20", pattern_alpha=0.5, show.legend = "point") + scale_pattern_manual(values = c("Agreement < 66%" = "stripe")) + 
  #geom_sf_text(aes(label = sprintf("%+.1f", gdp_median_change) , geometry = geometry), colour = "black", size=3.5) + 
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) + theme(strip.text.y = element_text(size = 7), legend.position = c(.5,.15), legend.direction = "horizontal", legend.background=element_blank()) + theme(panel.spacing = unit(10, "lines"))
#combined
ggpubr::ggarrange(g, p_map_gdp, ncol=1, nrow=2, heights = c(2.2, 1.1), align = "hv")
ggsave(filename = file.path(graphdir, "GDP_violinplot_final_modeldifferences_withmaps.pdf"), width = 8, height = 6, device = cairo_pdf) 




#Welfare
ggplot(data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% arrange(Type)  %>% mutate(Model = factor(Model, levels =  unique(Model))) %>% mutate(Year=as.character(Year), Model_offset=as.factor(Model), Model_offset=as.numeric(Model_offset), Year=gsub("2100", "2075", Year))) + labs(x="", y="", title = "", color ="Model") + facet_grid(Scenario.y.nice ~ ., scales = "free")  + theme_bw() + geom_hline(yintercept = 0) + labs(y="Change in Welfare from Reference [%]", x="", title="Impact on Welfare by Model and Model type") + scale_shape_manual(values=seq(0,9)) + theme(strip.text.y = element_text(size = 6)) +geom_point(aes(x = as.numeric(Year)+(Model_offset-4.5)/1.0, y = 100*((`value.y_GDP|PPP`*value.y_Equality_index)/(`value.x_GDP|PPP`*value.x_Equality_index)-1), color=Model, shape=Type)) + scale_x_continuous(breaks = c(2030, 2050, 2075), labels = c(2030, 2050, 2100)) + scale_shape_manual(values = c(15, 16, 17, 18)) + geom_text(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value= 100*((`value.y_GDP|PPP`*value.y_Equality_index)/(`value.x_GDP|PPP`*value.x_Equality_index)-1)) %>% summarize(value=mean(value, na.rm = T)) %>% ungroup() %>% group_by(Year, Scenario.y.nice) %>% summarize(value=median(value)) %>% mutate(label = sprintf("%+.1f", value)) %>% ungroup() %>% mutate(Year=gsub(2100, 2075, Year)), aes(x=as.numeric(Year), y=value+v_adjust_numbers*sign(value), label=label))
g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
ggsave(filename = file.path(graphdir, "Welfare_violinplot_final_modeldifferences.pdf"), width = 7, height = 5, plot = g, device = cairo_pdf)
#Welfare with maps (Figure 4)
p_map_welfare <- ggplot(data = data_map_geometry %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100)) + borders("world", colour = "grey80", fill = NA) + geom_sf(aes(fill = welfare_median_change, geometry = geometry)) + scale_fill_gradient2(low="red", high="blue", mid = "grey", midpoint = 0, guide="colorbar",na.value="white", limits=c(NA,NA))+ ggtitle("") + labs(fill = "", x = "", y = "") + theme_bw() + theme(strip.background = element_rect(fill = "grey"), legend.position = "bottom") + coord_sf(ylim = c(-50, 90))  + facet_grid(. ~ Year) + geom_sf_text(aes(label = sprintf("%+.1f", welfare_median_change) , geometry = geometry), colour = "black", size=3.5) + theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) + theme(strip.text.y = element_text(size = 7), legend.position = c(.5,.15), legend.direction = "horizontal", legend.background=element_blank()) + theme(panel.spacing = unit(10, "lines"))
#combined
ggpubr::ggarrange(g, p_map_welfare, ncol=1, nrow=2, heights = c(2.2, 1.1), align = "hv")
ggsave(filename = file.path(graphdir, "Welfare_violinplot_final_modeldifferences_withmaps.pdf"), width = 8, height = 6, device = cairo_pdf)  



#Figure 1 for 1150 "Weak Paris"
#violinplot Gini aggregated over time
ggplot(data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in%  c( "1150_impact", "1150_impact_redist", "REF_impact")) %>% mutate(Scenario.y=gsub("1150", "Paris", Scenario.y)) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% arrange(Type)  %>% mutate(Model = factor(Model, levels =  unique(Model))) %>% mutate(Year=as.character(Year), Model_offset=as.factor(Model), Model_offset=as.numeric(Model_offset), Year=gsub("2100", "2075", Year))) + labs(x="", y="", title = "", color ="Model") + facet_grid(Scenario.y.nice ~ ., scales = "free")  + theme_bw() + geom_hline(yintercept = 0) + labs(y="Change in Gini from Reference [points]", x="", title="Impact on the Gini index by Model and Model type") + scale_shape_manual(values=seq(0,9)) + theme(strip.text.y = element_text(size = 6)) +geom_point(aes(x = as.numeric(Year)+(Model_offset-4.5)/1.0, y = 100*(value.x_Equality_index-value.y_Equality_index), color=Model, shape=Type)) + scale_x_continuous(breaks = c(2030, 2050, 2075), labels = c(2030, 2050, 2100)) + scale_shape_manual(values = c(15, 16, 17, 18))  + geom_text_repel(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "1150_impact", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in%  c( "1150_impact", "1150_impact_redist", "REF_impact")) %>% mutate(Scenario.y=gsub("1150", "Paris", Scenario.y)) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=100*(value.x_Equality_index-value.y_Equality_index)) %>% summarize(value=mean(value)) %>% ungroup() %>% group_by(Year, Scenario.y.nice) %>% summarize(gini_agreement_num=paste0(round(100*sum(abs(sign(value))[sign(value) == sign(median(value))]) / n()),"%"), value=median(value)) %>% mutate(label = sprintf("%+.1f", value)) %>% ungroup() %>% mutate(Year=gsub(2100, 2075, Year)), aes(x=as.numeric(Year), y=value+v_adjust_numbers*sign(value), label=paste0(label, "\n Ag. ", gini_agreement_num)), nudge_x = 7, nudge_y=0.2, min.segment.length = 0, arrow=arrow(angle = 30, length = unit(0.1, "inches"),ends = "last", type = "closed"))

g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
ggsave(filename = file.path(graphdir, "Gini_violinplot_final_modeldifferences_1150.pdf"), width = 7, height = 5, plot = g, device = cairo_pdf)

#Gini with maps
p_map_gini <- ggplot(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2070, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in%  c( "1150_impact", "1150_impact_redist", "REF_impact")) %>% mutate(Scenario.y=gsub("1150", "Paris", Scenario.y)) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% mutate(Year=as.character(Year)) %>% filter(Year %in% c(2030, 2050, 2100)) %>% ungroup() %>% group_by(Region, Year, Scenario.y.nice) %>% summarize(gini_mean_change=mean(100*(value.x_Equality_index-value.y_Equality_index)), gini_median_change=median(100*(value.x_Equality_index-value.y_Equality_index)), welfare_median_change=median(100*((`value.y_GDP|PPP`*value.y_Equality_index)/(`value.x_GDP|PPP`*value.x_Equality_index)-1)), gdp_median_change=median(100*((`value.y_GDP|PPP`)/(`value.x_GDP|PPP`)-1)), gini_agreement_num=sum(abs(sign(100*(value.x_Equality_index-value.y_Equality_index)))[sign(100*(value.x_Equality_index-value.y_Equality_index)) == sign(median(100*(value.x_Equality_index-value.y_Equality_index)))]) / n()) %>% mutate(iso_a3 = countrycode::countrycode(Region, "country.name", "iso3c")) %>% ungroup() %>% full_join(world) %>% filter(!is.na(gini_mean_change)) %>% as.data.frame() %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100)) + borders("world", colour = "grey80", fill = NA) + 
  geom_sf(aes(fill = gini_median_change, geometry = geometry)) + scale_fill_gradient2(low="blue", high="red", mid = "grey", midpoint = 0, guide="colorbar",na.value="white") +
  geom_sf_pattern(data = subset(data_map_geometry %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100), gini_agreement_num < 0.66), aes(pattern = "Agreement < 66%", geometry = geometry), pattern = 'stripe', pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.02, pattern_color="grey20", pattern_alpha=0.5, show.legend = "point") + scale_pattern_manual(values = c("Agreement < 66%" = "stripe")) + 
  ggtitle("") + labs(fill = "", x = "", y = "") + theme_bw() + theme(strip.background = element_rect(fill = "grey"), legend.position = "bottom") + coord_sf(ylim = c(-50, 90))  + facet_grid(. ~ Year) + 
  #geom_sf_text(aes(label = sprintf("%+.1f", gini_median_change) , geometry = geometry), colour = "black", size=3.5) + 
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) + theme(strip.text.y = element_text(size = 7), legend.position = c(.5,.15), legend.direction = "horizontal", legend.background=element_blank()) + theme(panel.spacing = unit(10, "lines"))
#combined
ggpubr::ggarrange(g, p_map_gini, ncol=1, nrow=2, heights = c(2.2, 1.1), align = "hv")
ggsave(filename = file.path(graphdir, "Gini_violinplot_final_modeldifferences_withmaps_1150.pdf"), width = 8, height = 6, device = cairo_pdf) 



#Figure 1 now based on D8D2
ggplot(data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% arrange(Type)  %>% mutate(Model = factor(Model, levels =  unique(Model))) %>% mutate(Year=as.character(Year), Model_offset=as.factor(Model), Model_offset=as.numeric(Model_offset), Year=gsub("2100", "2075", Year))) + labs(x="", y="", title = "", color ="Model") + facet_grid(Scenario.y.nice ~ ., scales = "free")  + theme_bw() + geom_hline(yintercept = 0) + labs(y="Change in D80D20 ratio from Reference", x="", title="Impact on the D80D20 ratio by Model and Model type") + scale_shape_manual(values=seq(0,9)) + theme(strip.text.y = element_text(size = 6)) +geom_point(aes(x = as.numeric(Year)+(Model_offset-4.5)/1.0, y = (value.y_D8D2-value.x_D8D2), color=Model, shape=Type)) + scale_x_continuous(breaks = c(2030, 2050, 2075), labels = c(2030, 2050, 2100)) + scale_shape_manual(values = c(15, 16, 17, 18))  + geom_text_repel(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=(value.y_D8D2-value.x_D8D2)) %>% summarize(value=mean(value)) %>% ungroup() %>% group_by(Year, Scenario.y.nice) %>% summarize(D8D2_agreement_num=paste0(round(100*sum(abs(sign(value))[sign(value) == sign(median(value))]) / n()),"%"), value=median(value)) %>% mutate(label = sprintf("%+.1f", value)) %>% ungroup() %>% mutate(Year=gsub(2100, 2075, Year)), aes(x=as.numeric(Year), y=value+v_adjust_numbers*sign(value), label=paste0(label, "\n Ag. ", D8D2_agreement_num)), nudge_x = 7, nudge_y=0.2, min.segment.length = 0, arrow=arrow(angle = 30, length = unit(0.1, "inches"),ends = "last", type = "closed"))
#only a few facets having same scales
source("scale_inidividual_facet_y_axes.R")
ggplot_build(last_plot())$layout$panel_scales_y[[3]]$range$range
#scale_inidividual_facet_y_axes(last_plot(), ylims = list(c(-3.5,+3.5), c(-3.5,3.5), c(NULL, NULL)))
#scale_inidividual_facet_y_axes(last_plot(), ylims = list(c(-11.82,3.5), c(-11.82,3.5), c(-11.82,3.5)))
g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
#Gini with maps (Figure 1)
p_map_gini <- ggplot(data = data_map_geometry %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100)) + borders("world", colour = "grey80", fill = NA) + 
  geom_sf(aes(fill = D8D2_median_change, geometry = geometry)) + scale_fill_gradient2(low="blue", high="red", mid = "grey", midpoint = 0, guide="colorbar",na.value="white") +
  geom_sf_pattern(data = subset(data_map_geometry %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100), D8D2_agreement_num < 0.66), aes(pattern = "Agreement < 66%", geometry = geometry), pattern = 'stripe', pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.02, pattern_color="grey20", pattern_alpha=0.5, show.legend = "point") + scale_pattern_manual(values = c("Agreement < 66%" = "stripe")) + 
  ggtitle("") + labs(fill = "", x = "", y = "") + theme_bw() + theme(strip.background = element_rect(fill = "grey"), legend.position = "bottom") + coord_sf(ylim = c(-50, 90))  + facet_grid(. ~ Year) + 
  #geom_sf_text(aes(label = sprintf("%+.1f", D8D2_median_change) , geometry = geometry), colour = "black", size=3.5) + 
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) + theme(strip.text.y = element_text(size = 7), legend.position = c(.5,.15), legend.direction = "horizontal", legend.background=element_blank()) + theme(panel.spacing = unit(10, "lines"))
#combined
ggpubr::ggarrange(g, p_map_gini, ncol=1, nrow=2, heights = c(2.2, 1.1), align = "hv")
ggsave(filename = file.path(graphdir, "D80D20_violinplot_final_modeldifferences_withmaps.pdf"), width = 8, height = 6, device = cairo_pdf) 



#Welfare figure based on Atkinson EDE
ggplot(data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% arrange(Type)  %>% mutate(Model = factor(Model, levels =  unique(Model))) %>% mutate(Year=as.character(Year), Model_offset=as.factor(Model), Model_offset=as.numeric(Model_offset), Year=gsub("2100", "2075", Year))) + labs(x="", y="", title = "", color ="Model") + facet_grid(Scenario.y.nice ~ ., scales = "free")  + theme_bw() + geom_hline(yintercept = 0) + labs(y="Change in EDE from Reference [%]", x="", title="Impact on the EDE by Model and Model type") + scale_shape_manual(values=seq(0,9)) + theme(strip.text.y = element_text(size = 6)) +geom_point(aes(x = as.numeric(Year)+(Model_offset-4.5)/1.0, y = 100*((`value.y_GDP|PPP`*(1-value.y_Atkinson_1))/(`value.x_GDP|PPP`*(1-value.x_Atkinson_1))-1), color=Model, shape=Type)) + scale_x_continuous(breaks = c(2030, 2050, 2075), labels = c(2030, 2050, 2100)) + scale_shape_manual(values = c(15, 16, 17, 18)) + geom_text_repel(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value= 100*((`value.y_GDP|PPP`*(1-value.y_Atkinson_1))/(`value.x_GDP|PPP`*(1-value.x_Atkinson_1))-1)) %>% summarize(value=mean(value, na.rm = T)) %>% ungroup() %>% group_by(Year, Scenario.y.nice) %>% summarize(ede_agreement_num=paste0(round(100*sum(abs(sign(value))[sign(value) == sign(median(value))]) / n()),"%"), value=median(value)) %>% mutate(label = sprintf("%+.1f", value)) %>% ungroup() %>% mutate(Year=gsub(2100, 2075, Year)), aes(x=as.numeric(Year), y=value+v_adjust_numbers*sign(value), label=paste0(label, "\n Ag. ", ede_agreement_num)), nudge_x = 7, nudge_y=0.2, min.segment.length = 0, arrow=arrow(angle = 30, length = unit(0.1, "inches"),ends = "last", type = "closed"))
g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
#Welfare with maps (Figure 4)
p_map_welfare <- ggplot(data = data_map_geometry %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100)) + borders("world", colour = "grey80", fill = NA) + 
  geom_sf(aes(fill = ede_median_change, geometry = geometry)) + 
  geom_sf_pattern(data = subset(data_map_geometry %>% filter(Scenario.y.nice=="Paris with EPC" & Year < 2100), ede_agreement_num < 0.66), aes(pattern = "Agreement < 66%", geometry = geometry), pattern = 'stripe', pattern_angle = 45, pattern_density = 0.1, pattern_spacing = 0.02, pattern_color="grey20", pattern_alpha=0.5, show.legend = "point") + scale_pattern_manual(values = c("Agreement < 66%" = "stripe")) + 
  scale_fill_gradient2(low="red", high="blue", mid = "grey", midpoint = 0, guide="colorbar",na.value="white")+ ggtitle("") + labs(fill = "", x = "", y = "") + theme_bw() + theme(strip.background = element_rect(fill = "grey"), legend.position = "bottom") + coord_sf(ylim = c(-50, 90))  + facet_grid(. ~ Year) + 
  #geom_sf_text(aes(label = sprintf("%+.1f", welfare_median_change) , geometry = geometry), colour = "black", size=3.5) + 
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) + theme(strip.text.y = element_text(size = 7), legend.position = c(.5,.15), legend.direction = "horizontal", legend.background=element_blank()) + theme(panel.spacing = unit(10, "lines"))
#combined
ggpubr::ggarrange(g, p_map_welfare, ncol=1, nrow=2, heights = c(2.2, 1.1), align = "hv")
ggsave(filename = file.path(graphdir, "EDE_violinplot_final_modeldifferences_withmaps.pdf"), width = 8, height = 6, device = cairo_pdf)  


#finally same plot for Sen-Foster Welfare
p_boxplots_welfare <- ggplot(data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC")))) + 
  geom_point(aes(x = Region, y =  100*((`value.y_GDP|PPP`*(1-value.y_Atkinson_1))/(`value.x_GDP|PPP`*(1-value.x_Atkinson_1))-1), color=Model, shape=Model), size = 1) + facet_grid(Scenario.y.nice ~ Year, scales = "free")  + theme_bw() + geom_hline(yintercept = 0) + labs(y="Change in EDE welfare from Reference [%]", x="", title="Impact on the EDE") + geom_boxplot(aes(x = Region, y = 100*((`value.y_GDP|PPP`*value.y_Equality_index)/(`value.x_GDP|PPP`*value.x_Equality_index)-1)), alpha=0.2, color="grey50") + scale_x_discrete(limits = c("United States", "Canada", "France", "Japan", "Russia", "Mexico", "China", "Brazil", "South Africa", "India", "AVERAGE")) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + scale_shape_manual(values=seq(0,9)) + geom_boxplot(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value= 100*((`value.y_GDP|PPP`*(1-value.y_Atkinson_1))/(`value.x_GDP|PPP`*(1-value.x_Atkinson_1))-1)) %>% summarize(value=mean(value)), aes(x=11, y=value), alpha=0.4, color="black")+ geom_point(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value= 100*((`value.y_GDP|PPP`*(1-value.y_Atkinson_1))/(`value.x_GDP|PPP`*(1-value.x_Atkinson_1))-1)) %>% summarize(value=mean(value)), aes(x=11, y=value, color=Model, shape=Model), size=1)

print(p_boxplots_welfare + geom_text(data = data_welfare_effect_reordered %>% filter(Year %in% c(2030, 2050, 2100) & Region %in% countries_reported_max) %>% filter(Scenario.x=="REF" & Scenario.y %in% c("1150", "Paris", "1150_redist", "Paris_redist", "1150_impact_redist", "Paris_impact_redist", "REF_impact", "Paris_impact")) %>% filter(Scenario.y %in% c( "Paris_impact", "Paris_impact_redist", "REF_impact")) %>% mutate(Scenario.y=factor(Scenario.y)) %>% mutate(Scenario.y.start = as.numeric(Scenario.y) - 0.5, Scenario.y.end = as.numeric(Scenario.y) + 0.5, cbudget=gsub("[a-z_]","", Scenario.y)) %>% mutate(Scenario.y.nice=case_when(Scenario.y=="Paris_impact" ~ "Paris", Scenario.y=="Paris_impact_redist" ~ "Paris with EPC", Scenario.y=="REF_impact" ~ "No Climate Policy"), Scenario.y.nice = fct_relevel(as.factor(Scenario.y.nice), c("No Climate Policy", "Paris", "Paris with EPC"))) %>% group_by(Year, Scenario.y.nice, Model) %>% mutate(value=  100*((`value.y_GDP|PPP`*(1-value.y_Atkinson_1))/(`value.x_GDP|PPP`*(1-value.x_Atkinson_1))-1)) %>% summarize(value=mean(value, na.rm = T)) %>% ungroup() %>% group_by(Year, Scenario.y.nice) %>% summarize(value=median(value)) %>% mutate(label = sprintf("%+.1f", value)) %>% ungroup(), aes(x=11, y=value+2*sign(value), label=label)))
g <- ggplot_gtable(ggplot_build(last_plot()+ theme(strip.text.y = element_text(colour = 'white', face = "bold")))); stripr <- which(grepl('strip-r', g$layout$name)); fills <- c("#896200","darkblue","darkgreen")
k <- 1; for (i in stripr) {j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)); g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]; k <- k+1;}
grid::grid.draw(g)
ggsave(filename = file.path(graphdir, "EDE_boxplot_final.png"), width = 12, height = 8, plot = g)





#Gini baseline inequality plot
if(file.exists("C:\\Users\\Emmerling\\CMCC Dropbox\\Johannes Emmerling\\EIEE\\WITCH_CODING\\witch-data\\articles\\ssp_gini.csv")){
  gini_rao <- fread("C:\\Users\\Emmerling\\CMCC Dropbox\\Johannes Emmerling\\EIEE\\WITCH_CODING\\witch-data\\articles\\ssp_gini.csv")
  gini_hist <- fread("C:\\Users\\Emmerling\\CMCC Dropbox\\Johannes Emmerling\\EIEE\\WITCH_CODING\\witch-data\\inequality\\s_wiid\\s_wiid_data.csv")
  #plot the Gini for SSP2 for the countries in countries_reported_max
  ggplot() + geom_line(data = gini_rao %>% filter(iso3 %in% countrycode::countrycode(countries_reported_max, "country.name", "iso3c")) %>% filter(ssp=="ssp2" & year>= 2020), aes(year, gini, color=countrycode::countrycode(iso3, "iso3c", "country.name"))) + labs(x="", y="Gini index", color="Country") + geom_line(data = gini_hist %>% filter(iso3 %in% countrycode::countrycode(countries_reported_max, "country.name", "iso3c")) %>% filter(variable=="gini_swiid"), aes(year, value/100, color=countrycode::countrycode(iso3, "iso3c", "country.name")), linetype="dashed")  + ylim(0,1) + geom_label_repel(data = gini_rao %>% filter(iso3 %in% countrycode::countrycode(countries_reported_max, "country.name", "iso3c")) %>% filter(ssp=="ssp2" & year==2050-20+5*as.numeric(as.factor(iso3))), aes(year, gini, color=countrycode::countrycode(iso3, "iso3c", "country.name"), label=countrycode::countrycode(iso3, "iso3c", "country.name")), show.legend = FALSE) + scale_x_continuous(breaks = c(1960, 1980, 2000, 2020, 2050, 2100), limits = c(1960, 2100), minor_breaks = NULL) + stat_brace(aes(x=c(1960, 2018), y=c(0.8,0.85)), outside=F) + stat_brace(aes(x=c(2020, 2100), y=c(0.8,0.85)), outside=F) + geom_text(aes(1989,0.88, label="SWIID")) + geom_text(aes(2060,0.88, label="Rao et al. (2019)")) + ggtitle("Historical and projected baseline inequality")
  saveplot("Gini baseline", width = 8, height = 6)
}
